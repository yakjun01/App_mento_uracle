/*! MDatabase 2.1.4.6 [Android 2.1.4.5, iOS 2.1.4.6] */

(function( window, undefined ) {

'use strict';

var addonVersion = "2.1.4.6";

/**
 * 로컬 데이터 베이스의 기능들을 제공한다.
 * @class M.db
 * @group addon
 */
M.addon("db", {

	/** 
	 * 데이터베이스 파일을 생성한다.
	 * @memberof M.db
	 * @param {String} name 데이타베이스 파일 이름
	 * @param {M.db.DatabaseCreateCallback} [callback] 실행 결과 확인하는 함수
	 * @since 2.1.0
	 * @return {M}
	 */
	'create': function() {
		var defaultSetting, setting, result, context = window, nativeOptions = {};
		
		defaultSetting = M.defaultSetting.create({
			paramsKeys: ["path", "callback"],
			defaultSetting: {
				'path': '',
				'callback': function( status, result, setting ) {
					/**
					 * 데이타베이스 파일 생성 결과를 return
					 * @callback M.db.DatabaseCreateCallback
					 * @param {string} status 실행 결과 {SUCCESS:성공 코드,FAIL:실패 코드}
					 * @param {string} name 데이타베이스 파일 이름
					 */
					M.debug.log( 'M.db.create.callback', status, result );
				}
			},
			surrogateKeys: {
				'source': 'path',
				'alias': 'path',
				'name': 'path',
				'db': 'path',
				'database': 'path',
				'finish': 'callback',
				'onfinish': 'callback'
			},
			enumsKeys: {
				
			}
		});

		setting = defaultSetting.convert( arguments );
		nativeOptions.path = ( setting.path.indexOf('.db') === (setting.path.length-3) ) ? setting.path : (setting.path + ".db");
		
		result = M.execute("wn2DbCreate", nativeOptions);

		var status = result.status;
		var resultInfo = {};

		if ( result.error ) {
			resultInfo = {
				status: result.status,
				error: result.error,

				// surrogate options
				message: result.error
			};
		}
		else {
			resultInfo = {
				status: result.status,
				path: result.path || "",
				alias: result.alias || "",
				source: result.source || "",
				name: result.name || "",

				// surrogate options
				fullpath: result.source || "",
				db_name: result.name || ""
			};
		}

		setTimeout(function() {
			setting.callback.call( context, result.status, resultInfo, setting );
		}, 100);
		
		return resultInfo;
	},
	
	/** 
	 * 데이터베이스 파일을 삭제한다.
	 * @memberof M.db
	 * @param {String} name 데이타베이스 파일 이름
	 * @param {M.db.DatabaseRemoveCallback} [callback] 실행 결과 확인하는 함수
	 * @since 2.1.0
	 * @return {M}
	 */
	'remove': function( ) {
		var defaultSetting, setting, result, context = window, nativeOptions = {};
		
		defaultSetting = M.defaultSetting.create({
			paramsKeys: ["path", "callback"],
			defaultSetting: {
				'path': '',
				'callback': function( status, result ) {
					/**
					 * 데이타베이스 파일 삭제 결과를 return
					 * @callback M.db.DatabaseRemoveCallback
					 * @param {string} status 실행 결과 {SUCCESS:성공 코드,FAIL:실패 코드}
					 * @param {string} name 데이타베이스 파일 이름
					 */
					M.debug.log( 'M.db.remove.callback', status, result );
				}
			},
			surrogateKeys: {
				'source': 'path',
				'alias': 'path',
				'name': 'path',
				'db': 'path',
				'database': 'path',
				'finish': 'callback',
				'onfinish': 'callback'
			},
			enumsKeys: {
				
			}
		});

		setting = defaultSetting.convert( arguments );
		nativeOptions.path = ( setting.path.indexOf('.db') === (setting.path.length-3) ) ? setting.path : (setting.path + ".db");

		result = M.execute("wn2DbDelete", nativeOptions);

		var status = result.status;
		var resultInfo = {};

		if ( result.error ) {
			resultInfo = {
				status: result.status,
				error: result.error,

				// surrogate options
				message: result.error
			};
		}
		else {
			resultInfo = {
				status: result.status,
				path: result.path || "",
				alias: result.alias || "",
				source: result.source || "",
				name: result.name || "",

				// surrogate options
				fullpath: result.source || "",
				db_name: result.name || ""
			};
		}

		setTimeout(function() {
			setting.callback.call( context, result.status, result, setting );
		}, 100);
		
		return resultInfo;
	},
	
	/** 
	 * 데이터베이스 파일을 열게된다.
	 * @memberof M.db
	 * @param {String} name 데이타베이스 파일 이름
	 * @param {M.db.DatabaseOpenCallback} [callback] 실행 결과 확인하는 함수
	 * @since 2.1.0
	 * @return {M}
	 */
	'open': function( ) {
		var defaultSetting, setting, result, context = window, nativeOptions = {};
		
		defaultSetting = M.defaultSetting.create({
			paramsKeys: ["path", "callback"],
			defaultSetting: {
				'path': '',
				'callback': function( status, result ) {
					/**
					 * 데이타베이스 열린 상태를 return
					 * @callback M.db.DatabaseOpenCallback
					 * @param {string} status 실행 결과 {SUCCESS:성공 코드,FAIL:실패 코드}
					 * @param {string} name 데이타베이스 파일 이름
					 */

					M.debug.log( 'M.db.open.callback', status, result );
				}
			},
			surrogateKeys: {
				'source': 'path',
				'alias': 'path',
				'name': 'path',
				'db': 'path',
				'database': 'path',
				'finish': 'callback',
				'onfinish': 'callback'
			},
			enumsKeys: {
				
			}
		});

		setting = defaultSetting.convert( arguments );
		nativeOptions.path = ( setting.path.indexOf('.db') === (setting.path.length-3) ) ? setting.path : (setting.path + ".db");

		result = M.execute("wn2DbOpen", nativeOptions);

		var status = result.status;
		var resultInfo = {};

		if ( result.error ) {
			resultInfo = {
				status: result.status,
				error: result.error,

				// surrogate options
				message: result.error
			};
		}
		else {
			resultInfo = {
				status: result.status,
				path: result.path || "",
				alias: result.alias || "",
				source: result.source || "",
				name: result.name || "",

				// surrogate options
				fullpath: result.source || "",
				db_name: result.name || ""
			};
		}

		setTimeout(function() {
			setting.callback.call( context, result.status, resultInfo, setting );
		}, 100);
		
		return resultInfo;
	},
	
	/** 
	 * 데이터베이스 파일을 닫게된다.
	 * @memberof M.db
	 * @param {String} name 데이타베이스 파일 이름
	 * @param {M.db.DatabaseCloseCallback} [callback] 실행 결과 확인하는 함수
	 * @since 2.1.0
	 * @return {M}
	 */
	'close': function( ) {
		var defaultSetting, setting, result, context = window, nativeOptions = {};
		
		defaultSetting = M.defaultSetting.create({
			paramsKeys: ["path", "callback"],
			defaultSetting: {
				'path': '',
				'callback': function( status, result ) {
					/**
					 * 데이타베이스 열린 상태를 return
					 * @callback M.db.DatabaseCloseCallback
					 * @param {string} status 실행 결과 {SUCCESS:성공 코드,FAIL:실패 코드}
					 * @param {string} name 데이타베이스 파일 이름
					 */
					M.debug.log( 'M.db.close.callback', status, result );
				}
			},
			surrogateKeys: {
				'source': 'path',
				'alias': 'path',
				'name': 'path',
				'db': 'path',
				'database': 'path',
				'finish': 'callback',
				'onfinish': 'callback'
			},
			enumsKeys: {
				
			}
		});

		setting = defaultSetting.convert( arguments );
		nativeOptions.path = ( setting.path.indexOf('.db') === (setting.path.length-3) ) ? setting.path : (setting.path + ".db");
		
		result = M.execute("wn2DbClose", nativeOptions);

		var status = result.status;
		var resultInfo = {};

		if ( result.error ) {
			resultInfo = {
				status: result.status,
				error: result.error,

				// surrogate options
				message: result.error
			};
		}
		else {
			resultInfo = {
				status: result.status,
				path: result.path || "",
				alias: result.alias || "",
				source: result.source || "",
				name: result.name || "",

				// surrogate options
				fullpath: result.source || "",
				db_name: result.name || ""
			};
		}

		setTimeout(function() {
			setting.callback.call( context, result.status, resultInfo, setting );
		}, 100);
		
		return resultInfo;
	},

	'query': function() {
		return this.execute.apply( this, arguments );
	},
	
	/** 
	 * 데이터베이스 파일에 SQL을 실행한다.
	 * @memberof M.db
	 * @param {String} name 데이타베이스 파일 이름
	 * @param {String} sql SQL 구문 (SQL Lite)
	 * @param {M.db.DatabaseExecuteCallback} [callback] 실행 결과 확인하는 함수
	 * @since 2.1.0
	 * @return {M}
	 */
	'execute': function( ) {
		var defaultSetting, setting, result, context = window, nativeOptions = {};
		
		defaultSetting = M.defaultSetting.create({
			paramsKeys: ["path", "sql", "callback"],
			defaultSetting: {
				'path': '',
				'sql': '',
				'async': false,
				'multiple': false,
				'callback': function( status, result ) {
					/**
					 * 데이타베이스 열린 상태를 return
					 * @callback M.db.DatabaseExecuteCallback
					 * @param {string} status 실행 결과 {SUCCESS:성공 코드,FAIL:실패 코드}
					 * @param {object} result SQL 실행 결과
					 * @param {int} result.column_count 행 개수
					 * @param {int} result.row_count 결과 레코드 수
					 * @param {array} result.row_list 레코드 데이타
					 * @param {string} name 데이타베이스 파일 이름
					 */
					M.debug.log( 'M.db.execute.callback', status, result );
				}
			},
			surrogateKeys: {
				'source': 'path',
				'alias': 'path',
				'name': 'path',
				'db': 'path',
				'database': 'path',
				'finish': 'callback',
				'query': 'sql',
				'onfinish': 'callback'
			},
			enumsKeys: {
				
			}
		});

		setting = defaultSetting.convert( arguments );
		nativeOptions.path = ( setting.path.indexOf('.db') === (setting.path.length-3) ) ? setting.path : (setting.path + ".db");
		nativeOptions.sql = setting.sql;
		nativeOptions.async = setting.async == true ? 'Y' : 'N';
		nativeOptions.multiple = setting.multiple == true ? 'Y' : 'N';

		result = M.execute( "wn2DbExecute", nativeOptions );

		var status = result.status;
		var resultInfo = {};

		if ( result.error ) {
			resultInfo = {
				status: result.status,
				error: result.error,

				// surrogate options
				message: result.error
			};
		}
		else {

			if ( setting.multiple ) {
				resultInfo = {
					status: result.status,
					path: result.path || "",
					alias: result.alias || "",
					source: result.source || "",
					name: result.name || "",
					count: result.count,

					// surrogate options
					fullpath: result.source || "",
					db_name: result.name || ""
				};
			}
			else {
				var rows = result.rows || [];
				var fields = result.fields || [];

				for ( var i=0; i<rows.length; i++ ) {
					var row = rows[i];
					for ( var f=0; f<fields.length; f++ ) {
						var field = fields[f];
						row[f] = (typeof row[field] === undefined) ? row[f] : row[field];
					}
					rows[i] = row;
				}

				resultInfo = {
					status: result.status,
					path: result.path || "",
					alias: result.alias || "",
					source: result.source || "",
					name: result.name || "",
					count: 1,

					column_count: fields.length || 0,
					fields: fields,
					row_count: rows.length || 0,
					rows: rows,

					// surrogate options
					fullpath: result.source || "",
					db_name: result.name || "",
					columns: fields || [],
					column: fields || [],
					row_list: rows || []
				};
			}
		}

		setTimeout(function() {
			setting.callback.call( context, result.status, resultInfo, setting );

		}, 100);
		
		return resultInfo;
	}
}, addonVersion);

})(window);